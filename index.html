<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="styles.css" />
  <link rel="manifest" href="manifest.json" />
  <title>Memoroa</title>
</head>
<body>
  <div id="app">
    <div id="left-pane">
      <button id="new-note-btn">新增筆記</button>
      <ul id="note-list"></ul>
    </div>

    <div id="right-pane">
      <div id="password-area">
        <input type="password" id="password-input" placeholder="設定或輸入密碼" />
        <button id="unlock-btn">解鎖</button>
      </div>

      <div id="note-editor-area" style="display:none;">
        <div id="note-editor" contenteditable="true" placeholder="開始輸入..."></div>

        <div id="backup-area">
          <button id="backup-btn">備份</button>
          <button id="restore-btn">還原</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    let notes = [];
    let selectedNote = null;
    let encryptionPassword = "";
    let saveTimer = null;

    function saveToLocal() {
      if (!encryptionPassword) return;
      const encrypted = btoa(JSON.stringify(notes));
      localStorage.setItem("memoroa-data", encrypted);
    }

    function loadFromLocal() {
      const encrypted = localStorage.getItem("memoroa-data");
      if (!encrypted) return;
      try {
        const data = JSON.parse(atob(encrypted));
        notes = data;
      } catch (e) {
        console.error("解密失敗");
      }
    }

    function renderList() {
      const list = document.getElementById("note-list");
      list.innerHTML = "";

      notes.forEach((note) => {
        const li = document.createElement("li");
        li.className = "note-item";
        li.innerHTML = `
          <span class="title">${note.title}</span>
          <button class="delete-btn">X</button>
        `;

        // ⭐ 修正：mousedown 取代 click，避免錯誤
        li.addEventListener("mousedown", (e) => {
          if (e.target.closest(".delete-btn")) return;
          selectNote(note.id);
        });

        li.querySelector(".delete-btn").onclick = (e) => {
          e.stopPropagation();
          deleteNote(note.id);
        };

        if (selectedNote && selectedNote.id === note.id) {
          li.classList.add("active");
        }

        list.appendChild(li);
      });
    }

    function selectNote(id) {
      selectedNote = notes.find((n) => n.id === id);
      document.getElementById("note-editor").innerHTML = selectedNote.content;
      document.getElementById("note-editor").focus();
      renderList();
    }

    function deleteNote(id) {
      notes = notes.filter((n) => n.id !== id);
      selectedNote = null;
      document.getElementById("note-editor").innerHTML = "";
      saveToLocal();
      renderList();
    }

    document.getElementById("new-note-btn").onclick = () => {
      const newNote = {
        id: Date.now(),
        title: "未命名",
        content: "",
      };
      notes.push(newNote);
      selectNote(newNote.id);
      saveToLocal();
      renderList();
    };

    document.getElementById("note-editor").oninput = () => {
      if (!selectedNote) return;
      selectedNote.content = document.getElementById("note-editor").innerHTML;

      clearTimeout(saveTimer);
      saveTimer = setTimeout(saveToLocal, 400);
    };

    document.getElementById("unlock-btn").onclick = unlock;
    document.getElementById("password-input").onkeydown = (e) => {
      if (e.key === "Enter") unlock();
    };

    function unlock() {
      const pwd = document.getElementById("password-input").value.trim();
      if (!pwd) return;

      encryptionPassword = pwd;
      loadFromLocal();
      document.getElementById("password-area").style.display = "none";
      document.getElementById("note-editor-area").style.display = "block";
      renderList();
    }

    document.getElementById("backup-btn").onclick = async () => {
      try {
        const handle = await window.showSaveFilePicker({
          suggestedName: "memoroa-backup.mem",
          types: [{ description: "Memoroa Backup", accept: { "text/plain": [".mem"] } }],
        });

        const writable = await handle.createWritable();
        await writable.write(localStorage.getItem("memoroa-data"));
        await writable.close();

        alert("備份成功！");
      } catch (e) {
        alert("備份失敗：" + e);
      }
    };

    document.getElementById("restore-btn").onclick = async () => {
      try {
        const [file] = await window.showOpenFilePicker({
          types: [{ description: "Memoroa Backup", accept: { "text/plain": [".mem"] } }],
        });

        const fileData = await file.getFile();
        const text = await fileData.text();
        localStorage.setItem("memoroa-data", text);

        loadFromLocal();
        renderList();
        alert("還原成功！");
      } catch (e) {
        alert("還原失敗：" + e);
      }
    };
  </script>
</body>
</html>
